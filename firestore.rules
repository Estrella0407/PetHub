rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isDocumentOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/branch/$(request.auth.uid));
    }

    // Helper function to check if a pet belongs to the current user
    function isPetOwner(petId) {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/pet/$(petId)) &&
             get(/databases/$(database)/documents/pet/$(petId)).data.custId == request.auth.uid;
    }

    // 1. CUSTOMER
    match /customer/{customerId} {
      allow read, update: if isDocumentOwner(customerId) || isAdmin();
      allow create: if isSignedIn();

      match /cart/{cartItemId} {
         allow read, write: if isDocumentOwner(customerId);
      }
    }

    // 2. PET
    match /pet/{petId} {      // Allow a user to read or write THEIR OWN pet document
      allow get, write: if request.auth.uid == resource.data.custId;

      // Allow ANY authenticated user to perform queries on the pet collection
      // This is necessary for the recommendation engine to find similar pets.
      allow list: if request.auth != null;
    }

    // 3. BRANCH
    match /branch/{branchId} {
      allow read: if isAdmin() || isSignedIn();
      allow write: if isAdmin();
    }

    // 4. APPOINTMENT
    match /appointment/{appointmentId} {
      // Allow creation if the pet belongs to the user
      allow create: if isSignedIn() && isPetOwner(request.resource.data.petId);

      // Allow list queries for signed-in users
      // The actual filtering happens in the client based on petIds
      allow list: if isSignedIn();

      // For individual document reads (get), verify ownership
      allow get: if isAdmin() ||
                   (isSignedIn() && resource.data.branchId == request.auth.uid) ||
                   isPetOwner(resource.data.petId);

      // Allow update/delete if admin or pet owner
      allow update, delete: if isAdmin() || isPetOwner(resource.data.petId);
    }

    // 5. SERVICE
    match /service/{serviceId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // 6. NOTIFICATION
    match /notification/{notificationId} {
      allow create: if isSignedIn();
      allow read, update, delete: if isAdmin() || (isSignedIn() && resource.data.custId == request.auth.uid);
    }

    // 7. PRODUCT
    match /product/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // 8. ORDERS
    match /order/{orderId} {
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.custId;
      allow read: if isAdmin() || (isSignedIn() && resource.data.custId == request.auth.uid);
      allow update: if isAdmin() || (isSignedIn() && resource.data.custId == request.auth.uid);
      allow delete: if isAdmin();
    }

    // 9. PRODUCT ORDERS
    match /productOrder/{productOrderId} {
       allow create: if isSignedIn();
       allow read: if isAdmin() || (
         isSignedIn() &&
         exists(/databases/$(database)/documents/order/$(resource.data.orderId)) &&
         get(/databases/$(database)/documents/order/$(resource.data.orderId)).data.custId == request.auth.uid
       );
       allow update: if isAdmin();
       allow delete: if isAdmin();
    }

    // 10. BRANCH PRODUCT
    match /branchProduct/{docId} {
      allow read: if isSignedIn();

      allow update: if isAdmin()
        || (
          isSignedIn()
          && request.resource.data.stock is int
          && request.resource.data.stock <= resource.data.stock
          && request.resource.data.branchId == resource.data.branchId
          && request.resource.data.productId == resource.data.productId
        );
      allow create, delete: if isAdmin();
    }

    // 11. BRANCH SERVICE
    match /branchService/{docId} {
      // Any signed-in user (customers choosing a branch, admins managing) can read.
      allow read: if isSignedIn();
      // Only admins can create, update, or delete these links.
      allow write: if isAdmin();
    }
  }
}